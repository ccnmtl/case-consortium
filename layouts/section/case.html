<html>
        {{ partial "header.html" . }} 

<body class="search">
	<div id="page-wrapper">

	<!-- Header -->
  <div id="header-wrapper">
    <link rel="stylesheet" href="{{ .Site.BaseURL }}js/tablesorter/themes/blue/style.css" />
    <script type="text/javascript" src="/js/tablesorter/jquery.tablesorter.js"></script> 
	  {{ partial "header_section.html" . }}
	  <!-- End Header -->
  </div>

<!-- Main Wrapper -->
<div id="main-wrapper" class="box container">
	<!-- Search Box -->
  <div id="search">
		<form class="form-inline" role="search">
			<div class="input-group">
				<span class="ion-android-search"></span>
				<input id="q" type="text" placeholder="Search for Cases" onfocus="this.placeholder = ''" onblur="this.placeholder = 'Search for Cases'" />
        <button class="close-icon" id="clear-search" type="reset"></button>
				<div class="input-group-btn"></div>
			</div>
      
		</form>
	  <div id="search-results"></div>
      <!-- End Search Box -->
    <div class="active-facets"></div>
  </div>
  <!-- Browse Cases -->
  <div class="row 200% browse_cases">
    <!-- End Search Results -->
    <!-- Sidebar -->
	  <div class="3u 12u$(medium)" id="sidebar">
	    <!-- Facets -->
	    <div id="facets"></div>
	    <!-- End Facets -->
	  </div>
    <!-- End Sidebar -->
	  <div class="9u 12u$(medium) important(medium)">
		  <div id="content">
	      <!-- Content -->
        <table class="alt tablesorter" id="results"></table>
	      <!-- End Content -->
		  </div>
	  </div>

    <!-- End Browse Cases -->
    <!-- End Main Wrapper -->
  </div>
</div>

         {{ partial "footer.html" . }}

          <script data-export="true" data-file-extension="js" id="facetize">
            jQuery(document).ready(function(){
                $.getJSON('/js/api/cases.json').success(function(cases){
                      window.Cases = cases;
                  }).error(function(){
                      alert('There was a problem loading the cases.')
                  }).complete(function(){
                    //after cases have loaded this function runs, contains the information passed to
                    //faceted search and several methods called after the facested search is instantiated
                        function setTableHeaders(){
                            jQuery('#results').prepend('<thead>' +
                                                        '<tr>' +
                                                            '<th class="case_id_head">Case Number</th>' +
                                                            '<th class="case_title_head">Title</th>' +
                                                            '<th class="case_topics_head">Category</th>' +
                                                        '</tr>' +
                                                       '</thead>');
                        }
                        function setFacetTags(){
                            $('.active-facets').html(
                                '<span class="category" style="display:none">Category: </span>' +
                                '<span class="topics" style="display:none">Topics: </span>' +
                                '<span class="related_cases" style="display:none">Related Cases: </span>');

                        }
                        function updateQueryParams(){
                            //get and update the url based on the active facets
                            //console.log("updateQueryParams()");
                            var new_path = "/case/";
                            var stateObj = { currentUrl: new_path };

                            _.each(settings.state.filters, function(filter, facetname) 
                            {
                                for(var x=0; x < filter.length; x++)
                                {
                                    if(new_path === "/case/")
                                    {
                                        new_path = new_path +  "?" + facetname + "=" + filter[x];
                                    }
                                    else
                                    {
                                        new_path = new_path + "&" + facetname + "=" + filter[x];
                                    }
                                }
                            });
                            window.history.pushState(stateObj, "case-search", new_path);
                            //console.log("End of updateQueryParamsAndBreadCrumbs()");
                        }
                        function displayActiveFacetTags(){
                            // start redrawing UI
                            setFacetTags();
                            // add tags under search bar for active filters
                            _.each(settings.state.filters, function(filter, facetname) 
                            {  
                                // If active show facet tag
                                $('.active-facets .'+facetname+'').show();
                                // for each filter, add a label for it to the tag
                                for(var x=0; x < filter.length; x++)
                                {
                                    $('.active-facets .'+facetname+'').append(
                                      "<span class='active-search-term' data-filtername='"+
                                      filter[x]+"'>"+filter[x]+
                                      "<span class='glyphicon glyphicon-remove'></span></span>");
                                }
                            });
                            updateQueryParams();
                        }
                        function removeActiveFacet(){
                          console.log("removeActiveFacet()");
                          var filterText = jQuery(this).parent().text();
                          var facetText = jQuery(this).parent().parent().html().split(':')[0].toLowerCase();
                          
                          //console.log(facetText);
                          //console.log(filterText);


                          var filterHTML = jQuery(this).parent().html();
                                var facetHTML = jQuery(this).parent().parent().parent().html();
                                console.log(facetHTML);
                                console.log(filterHTML);
                          // go over all currently active facets
                          _.each(settings.state.filters, function(filter, facetname) 
                          {
                            if(facetname === facetText){
                              try {
                                console.log('try block');
                                //console.log(facetname);
                                //console.log(facetText);
                                console.log("settings.state.filters[facetname]");
                                console.log(settings.state.filters[facetname]);
                                console.log("settings.state.filters[facetname].length");
                                console.log(settings.state.filters[facetname].length);
                                //console.log(facetname);
                                //var findFilter = _.indexOf(settings.state.filters[facetname], filterText);
                                //console.log("findFilter");
                                //console.log(findFilter);
                                settings.state.filters[facetname].pop(filterText);
                                console.log("settings.state.filters[facetname]");
                                console.log(settings.state.filters[facetname]);

                                

                                // and remove the filter
                                jQuery.facetUpdate();
                                
                              }
                              catch(error)
                              {
                                console.log("need to handle errors here...");
                                console.log(error);
                              }
                            }

                          });
                          //jQuery.facetUpdate();
                          //updateQueryParamsAndBreadCrumbs();

                        }
                        window.unescapeHtml = function(){
                            jQuery('.unescape').each(function(){
                                var text = jQuery(this).text();
                                jQuery(this).html(text);
                            });
                        }

                        var item_template =
                            '<tr class="item">' +
                              '<td class="case_id" id="case-id-<%= obj.id %>"><div class="desc hidden"><%= obj.description %></div>' +
                              '<span class="unescape"><%= obj.case_number %></span></td>' +
                              '<td class="case_slug"><a href="<%= obj.slug %>">'+
                              '<h4 class="unescape"> <%= obj.title %></h4> </a></td>' +
                              '<td class="case_topics"><a href="/category/<%= obj.cat_url %>"> <span><%= obj.category %></span></a></td>' +
                            '</tr>';

                        settings = {
                              items            : Cases.cases,
                              facets           : {
                                                  'category': 'Category',
                                                  'topics': 'Filter by Topic',
                                                  'related_cases': 'Related Cases'
                                                 },
                              resultSelector   : '#results',
                              facetSelector    : '#facets',
                              resultTemplate   : item_template,
                              paginationCount  : 1000,
                              orderByOptions   : {'case_number': 'Case Number', 'title': 'Title'},
                              bottomContainer    : '<div class="bottom-container"></div>',
                              showMoreTemplate   : '<a id=showmorebutton>Show More</a>',
                              state: {
                                filters : {}
                              }
                        }
                           //(window.location.href.indexOf('?') === -1 && window.location.href.split('?')))
                        // see if a certain search result is indicated by the URL
                        if (window.location.href.indexOf('?') === -1)
                        {
                              setFacetTags();
                        }
                        if (window.location.href.indexOf('?') !== -1 )//||
                        {
                            setFacetTags();
                            try {
                                var qry_params = window.location.href.split('?');
                                var params = qry_params[1];

                                // first check which facets are in url
                                if (params.indexOf('category') !== -1)
                                {
                                  $.extend(settings.state.filters, {'category': []});
                                }
                                if (params.indexOf('topics') !== -1)
                                {
                                  $.extend(settings.state.filters, {'topics': []});
                                }
                                if (params.indexOf('related_cases') !== -1)
                                {
                                  $.extend(settings.state.filters, {'related_cases': []});
                                }

                                var active_facets = params.split('&');
                                
                                // go over url parameters and re create search results
                                for(var count_params=1; count_params < active_facets.length; count_params++)
                                {
                                    var find_facet = active_facets[count_params].split('=');
                                    var facet = find_facet[0]; //category/related topics/
                                    var search_term = find_facet[1];

                                    settings.state.filters[facet].push(decodeURI(search_term));
                                    
                                }

                                displayActiveFacetTags();
                                
                            }
                            catch(error){
                              //console.log("Inside catch block");
                              console.log(error);
                            }
                          }

                          
                          
                        
                          jQuery.facetelize(settings);

                          setTableHeaders();
                          unescapeHtml();
                          // calling tablesorter library to order results of search
                          jQuery("#results").tablesorter(); 


                          jQuery('.orderbyitem')
                            .add(jQuery('.facetitem'))
                            .add(jQuery('.deselectstartover'))
                            .add(jQuery('#showmorebutton'))
                            .on('click', function(){
                                setTableHeaders();
                                unescapeHtml();
                            })

                          jQuery('.facetitem').on('click', displayActiveFacetTags);
                          jQuery('.deselectstartover').on('click', displayActiveFacetTags);
                          // for some reason this does not seem to apply to the glyphs added later
                          jQuery('.glyphicon-remove').on('click', removeActiveFacet);

                  })
                   //jQuery('.rm-facet').on('click', window.removeActiveFacet);
              });
            </script>
            
    </body>

</html>
